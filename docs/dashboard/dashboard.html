<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Sanjeevan - Dashboard</title>
  <style>
    body { font-family: Arial, sans-serif; margin:0; padding:0; background:#f5f7fb; color:#111; }
    .navbar { display:flex; justify-content:space-between; align-items:center; padding:12px 20px; background:#0b5fff; color:#fff; }
    .brand { font-size:20px; cursor:pointer; }
    .dropdown { position:relative; }
    .dropbtn { background:transparent; color:#fff; border:none; cursor:pointer; padding:8px; font-size:16px; }
    .dropdown-content { display:none; position:absolute; right:0; background:#fff; min-width:180px; box-shadow:0 4px 12px rgba(0,0,0,0.15); border-radius:6px; overflow:hidden; }
    .dropdown-content button { width:100%; padding:10px 12px; border:0; background:transparent; text-align:left; cursor:pointer; }
    .dropdown:hover .dropdown-content { display:block; }
    .container { padding:20px; max-width:980px; margin:20px auto; }
    .card { background:#fff; padding:16px; border-radius:10px; box-shadow:0 6px 18px rgba(2,6,23,0.06); margin-bottom:16px; }
    .row { display:flex; gap:16px; align-items:center; }
    .col { flex:1; }
    .field { display:block; width:100%; padding:8px; margin-top:8px; border-radius:6px; border:1px solid #d6dde9; }
    .btn { padding:8px 12px; border-radius:8px; border:0; cursor:pointer; background:#0b5fff; color:#fff; }
    .btn.secondary { background:#6b7280; }
    h3 { margin:0; }
    .posts-grid { display:flex; flex-direction:column; gap:12px; margin-top:12px; }
    .post-card { padding:12px; border-radius:8px; border:1px solid #e6eefb; background:#fff; }
    .small { font-size:13px; color:#444; }
    .muted { color:#657085; font-size:13px; }
    .flex-between { display:flex; justify-content:space-between; align-items:center; }
    .alert-card { border-left:4px solid #ff6b6b; padding-left:12px; background:#fff7f7; }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@4/dist/email.min.js"></script>




</head>
<body>

  <div class="navbar">
    <div class="brand" id="brand">Sanjeevan</div>

    <div class="dropdown">
      <button class="dropbtn">Menu ▾</button>
      <div class="dropdown-content">
        <button id="exploreBtn">Explore cases</button>
        <button id="askAiBtn">Ask AI</button>
        <button id="casesOverviewBtn">Cases Overview</button>
        <button id="deleteAccountBtn" style="color:#b91c1c">Delete account</button>
      </div>
    </div>
  </div>

  <div class="container">
    <div class="card" id="userCard">
      <div class="flex-between">
        <div>
          <h3 id="displayName">—</h3>
          <div class="muted" id="displayEmail">—</div>
          <div class="muted" id="displayAge">Age: —</div>
        </div>
        <div>
          <button class="btn secondary" id="editProfileBtn">Edit</button>
        </div>
      </div>
    </div>

    <div class="card">
      <h3>Make a post</h3>
      <div style="margin-top:12px">
        <input id="locationInput" class="field" placeholder="Area / Location" />
       <input id="dateInput" class="field" type="date" placeholder="Select date" />
       <input id="timeInput" class="field" type="text" placeholder="Enter time HH:MM (24hr format)" />

        <input id="whatFacingInput" class="field" placeholder="What am I facing (e.g., tested positive / fever)" />
        <input id="symptomsInput" class="field" placeholder="Symptoms (comma separated)" />
        <div style="margin-top:10px">
          <button class="btn" id="postBtn">POST</button>
        </div>
      </div>
    </div>

    <div class="card">
      <div class="flex-between">
        <h3>My Posts</h3>
      </div>
      <div id="myPosts" class="posts-grid"></div>
    </div>

    <div class="card">
      <div class="flex-between">
        <h3>My Alerts</h3>
      </div>
      <div id="myAlerts" class="posts-grid"></div>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getAuth, onAuthStateChanged, deleteUser, reauthenticateWithCredential, EmailAuthProvider, signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
    import {
      getFirestore,
      doc,
      getDoc,
      updateDoc,
      collection,
      query,
      where,
      orderBy,
      onSnapshot,
      addDoc,
      serverTimestamp,
      deleteDoc,
      getDocs
    } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyB3Pnr04DrjcBBsaHx3rr0RINktnQHs0oY",
            authDomain: "kairos232005.firebaseapp.com",
            databaseURL: "https://kairos232005-default-rtdb.firebaseio.com",
            projectId: "kairos232005",
            storageBucket: "kairos232005.firebasestorage.app",
            messagingSenderId: "750292953272",
            appId: "1:750292953272:web:c6f7e85f64b6d52096ec4d"
    };

    const EMAILJS_PUBLIC_KEY = "YOUR_EMAILJS_PUBLIC_KEY";
    const EMAILJS_SERVICE_ID = "YOUR_EMAILJS_SERVICE_ID";
    const EMAILJS_TEMPLATE_ID = "YOUR_EMAILJS_TEMPLATE_ID";

    

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    const brand = document.getElementById('brand');
    const exploreBtn = document.getElementById('exploreBtn');
    const askAiBtn = document.getElementById('askAiBtn');
    const casesOverviewBtn = document.getElementById('casesOverviewBtn');
    const deleteAccountBtn = document.getElementById('deleteAccountBtn');
    const displayNameEl = document.getElementById('displayName');
    const displayEmailEl = document.getElementById('displayEmail');
    const displayAgeEl = document.getElementById('displayAge');
    const editProfileBtn = document.getElementById('editProfileBtn');

    const locationInput = document.getElementById('locationInput');
    const datetimeInput = document.getElementById('datetimeInput');
    const whatFacingInput = document.getElementById('whatFacingInput');
    const symptomsInput = document.getElementById('symptomsInput');
    const postBtn = document.getElementById('postBtn');

    const myPostsEl = document.getElementById('myPosts');
    const myAlertsEl = document.getElementById('myAlerts');

    let currentUser = null;
    let currentUserData = null;
    let alertedSet = new Set();

    brand.addEventListener('click', () => { location.href = '../auth/index.html'; });
    exploreBtn.addEventListener('click', () => { alert('Explore cases — placeholder'); });
    askAiBtn.addEventListener('click', () => { location.href = '../dashboard/ai.html'; });
    casesOverviewBtn.addEventListener('click', () => { alert('Cases Overview — placeholder'); });

    onAuthStateChanged(auth, async (user) => {
      if (!user) {
        location.href = '../index.html';
        return;
      }
      currentUser = user;
      await loadCurrentUserData();
      startPostsListener();
    });

    async function loadCurrentUserData() {
      const udocRef = doc(db, 'users', currentUser.uid);
      const udocSnap = await getDoc(udocRef);
      if (udocSnap.exists()) {
        currentUserData = udocSnap.data();
      } else {
        currentUserData = { name: currentUser.displayName || '', email: currentUser.email || '', age: null };
        await updateDoc(udocRef, currentUserData).catch(()=>{});
      }
      renderUserInfo();
    }

    function renderUserInfo() {
      displayNameEl.textContent = currentUserData.name || '(no name)';
      displayEmailEl.textContent = currentUserData.email || currentUser.email;
      displayAgeEl.textContent = `Age: ${currentUserData.age ?? '—'}`;
    }

    editProfileBtn.addEventListener('click', async () => {
      const name = prompt('Edit name', currentUserData.name || '');
      if (name === null) return;
      const ageStr = prompt('Edit age', currentUserData.age ?? '');
      if (ageStr === null) return;
      const age = ageStr === '' ? null : Number(ageStr);
      const udocRef = doc(db, 'users', currentUser.uid);
      await updateDoc(udocRef, { name, age }).catch(e=>alert(e.message));
      currentUserData.name = name;
      currentUserData.age = age;
      renderUserInfo();
    });

    deleteAccountBtn.addEventListener('click', async () => {
      if (!confirm('Delete account permanently? This cannot be undone.')) return;
      try {
        await performAccountDeletion();
      } catch (err) {
        alert(err.message || String(err));
      }
    });

    async function performAccountDeletion() {
      try {
        await deleteUser(currentUser);
      } catch (err) {
        if (err && err.code === 'auth/requires-recent-login') {
          const pw = prompt('For security, re-enter your password to delete account:');
          if (!pw) throw new Error('Password required to re-authenticate.');
          const credential = EmailAuthProvider.credential(currentUser.email, pw);
          await reauthenticateWithCredential(currentUser, credential);
          await deleteUser(currentUser);
        } else {
          throw err;
        }
      }

      const udocRef = doc(db, 'users', currentUser.uid);
      await deleteDoc(udocRef).catch(()=>{});

      const postsCol = collection(db, 'posts');
      const postsSnap = await getDocs(query(postsCol, where('uid', '==', currentUser.uid)));
      const deletePromises = [];
      postsSnap.forEach(d => deletePromises.push(deleteDoc(doc(db, 'posts', d.id))));
      await Promise.all(deletePromises).catch(()=>{});

      try { await signOut(auth); } catch(e){}

      location.href = '../auth/index.html';
    }

    postBtn.addEventListener('click', async () => {
  const locationVal = locationInput.value.trim();
  const dateVal = document.getElementById('dateInput').value;
  const timeVal = document.getElementById('timeInput').value.trim();
  const whatFacingVal = whatFacingInput.value.trim();
  const symptomsVal = symptomsInput.value.trim();

  if (!locationVal || !dateVal || !timeVal || !whatFacingVal) {
    alert('Please fill Location, Date, Time, and What am I facing fields.');
    return;
  }

  // Combine date + time into a single ISO string
  const datetimeStr = `${dateVal}T${timeVal}:00`; // seconds added
  const epoch = new Date(datetimeStr).getTime(); // treat input as local


  if (isNaN(epoch)) {
    alert('Invalid date or time format. Please use HH:MM (24hr) for time.');
    return;
  }

  const postsColRef = collection(db, 'posts');
  const userPostsSnap = await getDocs(query(postsColRef, where('uid', '==', currentUser.uid)));
  const postNumber = userPostsSnap.size + 1;

  try {
    await addDoc(postsColRef, {
      uid: currentUser.uid,
      name: currentUserData.name || currentUser.email,
      email: currentUser.email,
      location: locationVal,
      datetimeLocal: datetimeStr,
      epoch,
      whatFacing: whatFacingVal,
      symptoms: symptomsVal,
      postNumber,
      createdAt: serverTimestamp()
    });
    alert("✅ Post created successfully!");
    locationInput.value = '';
    document.getElementById('dateInput').value = '';
    document.getElementById('timeInput').value = '';
    whatFacingInput.value = '';
    symptomsInput.value = '';
  } catch (err) {
    alert("❌ Error saving post: " + (err.message || String(err)));
  }
});


    let postsUnsubscribe = null;

    function startPostsListener() {
      const postsColRef = collection(db, 'posts');
      postsUnsubscribe = onSnapshot(postsColRef, (snap) => {
        console.log("📡 Snapshot triggered, posts count:", snap.size);
        const allPosts = [];
        snap.forEach(d => allPosts.push({ id: d.id, ...d.data() }));
        renderMyPosts(allPosts);
        computeAndRenderAlerts(allPosts);
      }, (err) => {
        console.error('posts listener error', err);
      });
    }

    function renderMyPosts(allPosts) {
  const myPosts = allPosts
    .filter(p => p.uid === currentUser.uid)
    .sort((a, b) => (b.epoch || 0) - (a.epoch || 0));

  myPostsEl.innerHTML = '';

  if (myPosts.length === 0) {
    myPostsEl.innerHTML = '<div class="muted">You have not posted anything yet.</div>';
    return;
  }

  myPosts.forEach(p => {
    const div = document.createElement('div');
    div.className = 'post-card';

    const dt = p.datetimeLocal
      ? p.datetimeLocal.replace('T', ' ')
      : (p.epoch ? new Date(p.epoch).toLocaleString() : '');

    div.innerHTML = `
      <div class="flex-between">
        <div><strong>${escapeHtml(p.location)}</strong></div>
        <div class="small">Post #${p.postNumber ?? '-'}</div>
      </div>
      <div class="small muted">Visited: ${escapeHtml(String(dt))}</div>
      <div style="margin-top:6px"><strong>${escapeHtml(p.whatFacing)}</strong></div>
      <div class="muted" style="margin-top:6px">Symptoms: ${escapeHtml(p.symptoms || '—')}</div>
      <div style="margin-top:8px">
        <button class="btn secondary btn-edit" data-post-id="${p.id}">Edit</button>
        <button class="btn secondary btn-delete" style="background:#b91c1c" data-post-id="${p.id}">Delete</button>
      </div>
    `;

    myPostsEl.appendChild(div);

    // DELETE POST
    div.querySelector('.btn-delete').addEventListener('click', async (e) => {
      const postId = e.target.dataset.postId;
      if (!confirm('Are you sure you want to delete this post?')) return;
      try {
        await deleteDoc(doc(db, 'posts', postId));
        alert('Post deleted successfully.');
      } catch (err) {
        alert('Error deleting post: ' + (err.message || String(err)));
      }
    });

    // EDIT POST
    div.querySelector('.btn-edit').addEventListener('click', async (e) => {
      const postId = e.target.dataset.postId;
      const postDoc = allPosts.find(p => p.id === postId);
      if (!postDoc) return;

      const newLocation = prompt('Edit location', postDoc.location);
      if (newLocation === null) return;

      const newDate = prompt('Edit date (YYYY-MM-DD)', postDoc.datetimeLocal?.split('T')[0] || '');
      if (newDate === null) return;

      const newTime = prompt('Edit time (HH:MM, 24hr)', postDoc.datetimeLocal?.split('T')[1] || '');
      if (newTime === null) return;

      const newWhatFacing = prompt('Edit What am I facing', postDoc.whatFacing || '');
      if (newWhatFacing === null) return;

      const newSymptoms = prompt('Edit Symptoms', postDoc.symptoms || '');
      if (newSymptoms === null) return;

      const newDatetimeStr = `${newDate}T${newTime}:00`;
      const newEpoch = new Date(newDatetimeStr).getTime();
      if (isNaN(newEpoch)) {
        alert('Invalid date or time');
        return;
      }

      try {
        await updateDoc(doc(db, 'posts', postId), {
          location: newLocation,
          datetimeLocal: newDatetimeStr,
          epoch: newEpoch,
          whatFacing: newWhatFacing,
          symptoms: newSymptoms
        });
        alert('Post updated successfully.');
      } catch (err) {
        alert('Error updating post: ' + (err.message || String(err)));
      }
    });
  });
}

    function computeAndRenderAlerts(allPosts) {
  console.log("⚡ computeAndRenderAlerts running. Total posts:", allPosts.length);

  const myPosts = allPosts.filter(p => p.uid === currentUser.uid);
  const otherPosts = allPosts.filter(p => p.uid !== currentUser.uid);

  const alertsMap = new Map();

  // Enhanced location normalization: lowercase, trim, remove punctuation, collapse spaces
  const normalizeLocation = loc =>
    loc.trim()
       .toLowerCase()
       .replace(/[.,\/#!$%\^&\*;:{}=\-_`~()]/g, '')
       .replace(/\s+/g, ' ');

  const getDateStr = epoch => new Date(epoch).toISOString().split('T')[0]; // YYYY-MM-DD

  for (const myp of myPosts) {
    if (!myp.location || !myp.epoch) continue;

    for (const op of otherPosts) {
      if (!op.location || !op.epoch) continue;

      if (
        normalizeLocation(op.location) === normalizeLocation(myp.location) &&
        getDateStr(op.epoch) === getDateStr(myp.epoch) &&
        op.epoch < myp.epoch
      ) {
        console.log("✅ Alert condition matched! Other post id:", op.id);
        alertsMap.set(op.id, op);
      }
    }
  }

  const newAlertIds = [];
  for (const id of alertsMap.keys()) {
    if (!alertedSet.has(id)) newAlertIds.push(id);
  }

  for (const id of newAlertIds) {
    const op = alertsMap.get(id);
    sendAlertEmail(currentUser.email, {
      to_name: currentUserData.name || currentUser.email,
      from_name: op.name || op.email || 'Someone',
      location: op.location,
      datetime: op.datetimeLocal || (op.epoch ? new Date(op.epoch).toLocaleString() : ''),
      message: `${op.name || op.email} has visited ${op.location} at ${op.datetimeLocal || new Date(op.epoch).toLocaleString()} and reported: ${op.whatFacing}`
    }).then(() => {
      alertedSet.add(id);
    }).catch(() => {
      alertedSet.add(id);
    });
  }

  renderAlerts(Array.from(alertsMap.values()));
}


function renderAlerts(alertList) {
  myAlertsEl.innerHTML = '';
  if (alertList.length === 0) {
    myAlertsEl.innerHTML = '<div class="muted">No alerts.</div>';
    return;
  }

  alertList.sort((a, b) => (b.epoch || 0) - (a.epoch || 0));

  alertList.forEach(a => {
    const div = document.createElement('div');
    div.className = 'post-card alert-card';
    const dt = a.datetimeLocal
           ? a.datetimeLocal.replace('T', ' ')
           : (a.epoch ? new Date(a.epoch).toLocaleString() : '');

    div.innerHTML = `
      <div class="flex-between">
        <div><strong>${escapeHtml(a.name || a.email || 'Someone')}</strong></div>
        <div class="small">Post #${a.postNumber ?? '-'}</div>
      </div>
      <div class="small muted">Visited: ${escapeHtml(String(dt))}</div>
      <div style="margin-top:6px"><strong>${escapeHtml(a.whatFacing)}</strong></div>
      <div class="muted" style="margin-top:6px">Symptoms: ${escapeHtml(a.symptoms || '—')}</div>
    `;
    myAlertsEl.appendChild(div);
  });
}




function escapeHtml(str) {
  if (!str) return '';
  return String(str).replace(/[&<>"'`=\/]/g, function (s) {
    return {
      '&': '&amp;',
      '<': '&lt;',
      '>': '&gt;',
      '"': '&quot;',
      "'": '&#39;',
      '/': '&#x2F;',
      '`': '&#x60;',
      '=': '&#x3D;'
    }[s];
  });
}

  </script>
  <script>
    // Initialize EmailJS once
    emailjs.init("F8iGzc13Igllqe6v1"); // <-- your real public key from EmailJS

    // Function to send alert emails
    function sendAlertEmail(toEmail, params) {
      return emailjs.send(
        "service_qfxsfnh",   // <-- your real Service ID
        "template_t9cyzom",  // <-- your real Template ID
        {
          title: params.title || '',   // maps to {{title}} in your template
          name: params.name || '',     // maps to {{name}}
          time: params.time || '',     // maps to {{time}}
          message: params.message || '', // maps to {{message}}
          to_email: toEmail             // optional if included in template
        }
      )
      .then(res => console.log("📧 Email sent:", res.status, res.text))
      .catch(err => console.error("❌ Email sending failed:", err));
    }
  </script>
</body>
</html>
