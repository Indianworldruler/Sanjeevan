<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Sanjeevan - Dashboard</title>
  <style>
  :root{
    --bg-top: #f6f8fc;
    --page-bg: #ffffff;
    --card-bg: #ffffff;
    --accent-a: #6d28d9; /* deep purple */
    --accent-b: #06b6d4; /* teal/cyan */
    --text: #0f172a;
    --muted: #64748b;
    --soft-border: #e6eefb;
    --shadow-1: 0 8px 24px rgba(15,23,42,0.08);
    --shadow-2: 0 4px 12px rgba(2,6,23,0.06);
  }

  /* base */
  * { box-sizing: border-box; }
  html,body { height:100%; margin:0; }
  body {
    font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
    -webkit-font-smoothing:antialiased;
    -moz-osx-font-smoothing:grayscale;
    color: var(--text);
    background: linear-gradient(180deg, var(--bg-top), #ffffff 60%);
    min-height: 100vh;
    display: flex;
    flex-direction: column;
  }

  /* NAV */
  .navbar {
    display:flex;
    align-items:center;
    justify-content:space-between;
    padding: 18px 28px;
    background: transparent;
    position: sticky;
    top:0;
    z-index: 40;
    backdrop-filter: blur(6px);
  }

  .brand {
    font-weight: 700;
    font-size: 20px;
    cursor: pointer;
    /* gradient text highlight for brand */
    background: linear-gradient(90deg, var(--accent-a), var(--accent-b));
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
    color: transparent;
  }

  
  /* Dropdown adjustments */
.dropdown { position: relative; z-index: 50; }
.dropdown-content {
  display: none;
  position: absolute;
  top: 100%; /* right below the button */
  right: 0;
  min-width: 220px;
  background: var(--card-bg);
  border-radius: 12px;
  box-shadow: var(--shadow-1);
  overflow: hidden;
  opacity: 0;
  pointer-events: none;
  transition: opacity 0.2s ease;
}
.dropdown-content button {
  width: 100%;
  padding: 12px 14px;
  border: none;
  text-align: left;
  background: transparent;
  cursor: pointer;
  font-size: 14px;
  color: var(--text);
}
.dropdown-content button:hover { background: #f7f9fc; }

.dropdown.show .dropdown-content {
  display: block;
  opacity: 1;
  pointer-events: auto;
}

.dropbtn {
  background: rgba(255,255,255,0.88);
  border: 1px solid rgba(15,23,42,0.04);
  padding: 8px 12px;
  border-radius: 10px;
  cursor: pointer;
  font-weight: 600;
  color: var(--text);
  box-shadow: var(--shadow-2);
  transition: transform 0.15s ease, background 0.15s ease;
}
.dropbtn:hover {
  transform: translateY(-1px);
  background: rgba(255,255,255,1);
}

  /* layout container */
  .container {
    max-width: 1200px;     /* keep it wide, not shrunken */
    width: calc(100% - 40px);
    margin: 28px auto;
    padding: 0 20px;
    flex: 1 0 auto;
  }

  /* cards */
  .card {
    background: var(--card-bg);
    padding: 22px;
    border-radius: 14px;
    box-shadow: var(--shadow-1);
    margin-bottom: 22px;
  }

  /* utility rows/cols */
  .row { display:flex; gap:18px; align-items:center; flex-wrap:wrap; }
  .col { flex:1; min-width:240px; } /* prevents extreme shrinking */

  /* headings, text */
  h3 { margin:0; font-size:18px; color:var(--accent-a); font-weight:700; }
  .small { font-size:13px; color:#374151; }
  .muted { color:var(--muted); font-size:13px; }

  /* form fields */
  .field {
    display:block;
    width:100%;
    padding:12px 14px;
    margin-top:12px;
    border-radius:10px;
    border:1px solid var(--soft-border);
    background:#ffffff;
    font-size:15px;
    transition: box-shadow .18s ease, border-color .18s ease;
  }
  .field:focus{
    outline: none;
    border-color: var(--accent-a);
    box-shadow: 0 8px 22px rgba(109,40,217,0.08);
  }

  /* buttons */
  .btn {
    display:inline-flex;
    align-items:center;
    justify-content:center;
    gap:8px;
    padding: 11px 16px;
    border-radius:12px;
    border:0;
    cursor:pointer;
    font-weight:700;
    font-size:15px;
    color:#ffffff;
    background: linear-gradient(90deg, var(--accent-a), var(--accent-b));
    box-shadow: 0 10px 30px rgba(109,40,217,0.12);
  }
  .btn:hover { transform: translateY(-2px); }
  .btn.secondary {
    background: transparent;
    color: var(--text);
    border: 1px solid rgba(15,23,42,0.06);
    box-shadow: var(--shadow-2);
    font-weight:600;
  }
  .btn.danger {
    background: linear-gradient(90deg,#d67979,#ff7d7d);
    box-shadow: 0 10px 24px rgba(223, 118, 118, 0.12);
  }

  /* posts / cards */
  .posts-grid { display:flex; flex-direction:column; gap:14px; margin-top:14px; }
  .post-card {
    padding:16px;
    border-radius:12px;
    border:1px solid #eef6ff;
    background:#fff;
  }
  .alert-card { border-left:4px solid #ff6b6b; background:#fff7f7; padding-left:12px; }

  .flex-between { display:flex; justify-content:space-between; align-items:center; gap:12px; }

  /* preserve original field types specific styling */
  input[type="date"].field { padding:10px 12px; }

  /* responsive â€” keep layout full-size on wide screens, stack neatly on mobile */
  @media (max-width: 980px) {
    .container { width: calc(100% - 28px); margin: 18px auto; }
    .row { gap:12px; }
    .field { font-size:15px; padding:10px 12px; }
    .card { padding:18px; border-radius:12px; }
  }

  @media (max-width: 620px) {
    .navbar { padding:12px 16px; }
    .brand { font-size:18px; }
    .row { flex-direction:column; align-items:stretch; }
    .col { min-width: auto; width:100%; }
    .btn { width:100%; padding:12px 14px; }
    .dropdown-content { right: 8px; left: auto; min-width: 180px; }
  }
</style>
  <script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@4/dist/email.min.js"></script>




</head>
<body>

  <div class="navbar">
    <div class="brand" id="brand">Sanjeevan</div>

    <div class="dropdown">
      <button class="dropbtn">Menu â–¾</button>
      <div class="dropdown-content">
        <button id="exploreBtn">View All Posts</button>
        <button id="casesOverviewBtn">Analysis</button>
        <button id="deleteAccountBtn" style="color:#ff0000">Delete account</button>
      </div>
    </div>
  </div>

  <div class="container">
    <div class="card" id="userCard">
      <div class="flex-between">
        <div>
          <h3 id="displayName">â€”</h3>
          <div class="muted" id="displayEmail">â€”</div>
          <div class="muted" id="displayAge">Age: â€”</div>
        </div>
        <div>
          <button class="btn secondary" id="editProfileBtn">Edit</button>
        </div>
      </div>
    </div>

    <div class="card">
      <h3>Make a post</h3>
      <div style="margin-top:12px">
        <input id="locationInput" class="field" placeholder="Area / Location" />
       <input id="dateInput" class="field" type="date" placeholder="Select date" />
       <input id="timeInput" class="field" type="text" placeholder="Enter time HH:MM (24hr format)" />

        <input id="whatFacingInput" class="field" placeholder="What am I facing (e.g., tested positive / fever)" />
        <input id="symptomsInput" class="field" placeholder="Symptoms (comma separated)" />
        <div style="margin-top:10px">
          <button class="btn" id="postBtn">POST</button>
        </div>
      </div>
    </div>

    <div class="card">
      <div class="flex-between">
        <h3>My Posts</h3>
      </div>
      <div id="myPosts" class="posts-grid"></div>
    </div>

    <div class="card">
      <div class="flex-between">
        <h3>My Alerts</h3>
      </div>
      <div id="myAlerts" class="posts-grid"></div>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getAuth, onAuthStateChanged, deleteUser, reauthenticateWithCredential, EmailAuthProvider, signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
    import {
      getFirestore,
      doc,
      getDoc,
      setDoc,
      updateDoc,
      collection,
      query,
      where,
      orderBy,
      onSnapshot,
      addDoc,
      serverTimestamp,
      deleteDoc,
      getDocs
    } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyB3Pnr04DrjcBBsaHx3rr0RINktnQHs0oY",
            authDomain: "kairos232005.firebaseapp.com",
            databaseURL: "https://kairos232005-default-rtdb.firebaseio.com",
            projectId: "kairos232005",
            storageBucket: "kairos232005.firebasestorage.app",
            messagingSenderId: "750292953272",
            appId: "1:750292953272:web:c6f7e85f64b6d52096ec4d"
    };

    emailjs.init("F8iGzc13Igllqe6v1");

    function sendAlertEmail(toEmail, params) {
  return emailjs.send(
    "service_qfxsfnh",   // your Service ID
    "template_t9cyzom",  // your Template ID
    {
      title: params.title || '',
      name: params.name || '',
      time: params.time || '',
      message: params.message || '',
      to_email: toEmail
    }
  )
  .then(res => console.log("ðŸ“§ Email sent:", res.status, res.text))
  .catch(err => console.error("âŒ Email sending failed:", err));
}

    const EMAILJS_PUBLIC_KEY = "YOUR_EMAILJS_PUBLIC_KEY";
    const EMAILJS_SERVICE_ID = "YOUR_EMAILJS_SERVICE_ID";
    const EMAILJS_TEMPLATE_ID = "YOUR_EMAILJS_TEMPLATE_ID";

    

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    const brand = document.getElementById('brand');
    const exploreBtn = document.getElementById('exploreBtn');
    const casesOverviewBtn = document.getElementById('casesOverviewBtn');
    const deleteAccountBtn = document.getElementById('deleteAccountBtn');
    const displayNameEl = document.getElementById('displayName');
    const displayEmailEl = document.getElementById('displayEmail');
    const displayAgeEl = document.getElementById('displayAge');
    const editProfileBtn = document.getElementById('editProfileBtn');

    const locationInput = document.getElementById('locationInput');
    const datetimeInput = document.getElementById('datetimeInput');
    const whatFacingInput = document.getElementById('whatFacingInput');
    const symptomsInput = document.getElementById('symptomsInput');
    const postBtn = document.getElementById('postBtn');

    const myPostsEl = document.getElementById('myPosts');
    const myAlertsEl = document.getElementById('myAlerts');

    let currentUser = null;
    let currentUserData = null;
    

    brand.addEventListener('click', () => {
      location.href = '../index.html';
    });

exploreBtn.addEventListener('click', () => {
  location.href = '../menu/posts.html';
});

casesOverviewBtn.addEventListener('click', () => {
  location.href = '../menu/analysis.html';
});

const dropdown = document.querySelector('.dropdown');
let timeout;

dropdown.addEventListener('mouseenter', () => {
  clearTimeout(timeout);
  dropdown.classList.add('show');
});

dropdown.addEventListener('mouseleave', () => {
  timeout = setTimeout(() => {
    dropdown.classList.remove('show');
  }, 200); // small delay for cursor to reach dropdown
});


    onAuthStateChanged(auth, async (user) => {
      if (!user) {
        location.href = '../index.html';
        return;
      }
      currentUser = user;
      await loadCurrentUserData();
      startPostsListener();
    });

    async function loadCurrentUserData() {
      const udocRef = doc(db, 'users', currentUser.uid);
      const udocSnap = await getDoc(udocRef);
      if (udocSnap.exists()) {
        currentUserData = udocSnap.data();
      } else {
        currentUserData = { name: currentUser.displayName || '', email: currentUser.email || '', age: null };
        await updateDoc(udocRef, currentUserData).catch(()=>{});
      }
      renderUserInfo();
    }

    function renderUserInfo() {
      displayNameEl.textContent = currentUserData.name || '(no name)';
      displayEmailEl.textContent = currentUserData.email || currentUser.email;
      displayAgeEl.textContent = `Age: ${currentUserData.age ?? 'â€”'}`;
    }

    editProfileBtn.addEventListener('click', async () => {
      const name = prompt('Edit name', currentUserData.name || '');
      if (name === null) return;
      const ageStr = prompt('Edit age', currentUserData.age ?? '');
      if (ageStr === null) return;
      const age = ageStr === '' ? null : Number(ageStr);
      const udocRef = doc(db, 'users', currentUser.uid);
      await updateDoc(udocRef, { name, age }).catch(e=>alert(e.message));
      currentUserData.name = name;
      currentUserData.age = age;
      renderUserInfo();
    });

    deleteAccountBtn.addEventListener('click', async () => {
      if (!confirm('Delete account permanently? This cannot be undone.')) return;
      try {
        await performAccountDeletion();
      } catch (err) {
        alert(err.message || String(err));
      }
    });

    async function performAccountDeletion() {
      try {
        await deleteUser(currentUser);
      } catch (err) {
        if (err && err.code === 'auth/requires-recent-login') {
          const pw = prompt('For security, re-enter your password to delete account:');
          if (!pw) throw new Error('Password required to re-authenticate.');
          const credential = EmailAuthProvider.credential(currentUser.email, pw);
          await reauthenticateWithCredential(currentUser, credential);
          await deleteUser(currentUser);
        } else {
          throw err;
        }
      }

      const udocRef = doc(db, 'users', currentUser.uid);
      await deleteDoc(udocRef).catch(()=>{});

      const postsCol = collection(db, 'posts');
      const postsSnap = await getDocs(query(postsCol, where('uid', '==', currentUser.uid)));
      const deletePromises = [];
      postsSnap.forEach(d => deletePromises.push(deleteDoc(doc(db, 'posts', d.id))));
      await Promise.all(deletePromises).catch(()=>{});

      try { await signOut(auth); } catch(e){}

      location.href = '../auth/index.html';
    }

    postBtn.addEventListener('click', async () => {
  const locationVal = locationInput.value.trim();
  const dateVal = document.getElementById('dateInput').value;
  const timeVal = document.getElementById('timeInput').value.trim();
  const whatFacingVal = whatFacingInput.value.trim();
  const symptomsVal = symptomsInput.value.trim();

  if (!locationVal || !dateVal || !timeVal || !whatFacingVal) {
    alert('Please fill Location, Date, Time, and What am I facing fields.');
    return;
  }

  // Combine date + time into a single ISO string
  const datetimeStr = `${dateVal}T${timeVal}:00`; // seconds added
  const epoch = new Date(datetimeStr).getTime(); // treat input as local


  if (isNaN(epoch)) {
    alert('Invalid date or time format. Please use HH:MM (24hr) for time.');
    return;
  }

  const postsColRef = collection(db, 'posts');
  const userPostsSnap = await getDocs(query(postsColRef, where('uid', '==', currentUser.uid)));
  const postNumber = userPostsSnap.size + 1;

  try {
    await addDoc(postsColRef, {
      uid: currentUser.uid,
      name: currentUserData.name || currentUser.email,
      email: currentUser.email,
      location: locationVal,
      datetimeLocal: datetimeStr,
      epoch,
      whatFacing: whatFacingVal,
      symptoms: symptomsVal,
      postNumber,
      createdAt: serverTimestamp()
    });
    alert("âœ… Post created successfully!");
    locationInput.value = '';
    document.getElementById('dateInput').value = '';
    document.getElementById('timeInput').value = '';
    whatFacingInput.value = '';
    symptomsInput.value = '';
  } catch (err) {
    alert("âŒ Error saving post: " + (err.message || String(err)));
  }
});


    let postsUnsubscribe = null;

    function startPostsListener() {
      const postsColRef = collection(db, 'posts');
      postsUnsubscribe = onSnapshot(postsColRef, (snap) => {
        console.log("ðŸ“¡ Snapshot triggered, posts count:", snap.size);
        const allPosts = [];
        snap.forEach(d => allPosts.push({ id: d.id, ...d.data() }));
        renderMyPosts(allPosts);
        computeAndRenderAlerts(allPosts);
      }, (err) => {
        console.error('posts listener error', err);
      });
    }

    function renderMyPosts(allPosts) {
  const myPosts = allPosts
    .filter(p => p.uid === currentUser.uid)
    .sort((a, b) => (b.epoch || 0) - (a.epoch || 0));

  myPostsEl.innerHTML = '';

  if (myPosts.length === 0) {
    myPostsEl.innerHTML = '<div class="muted">You have not posted anything yet.</div>';
    return;
  }

  myPosts.forEach(p => {
    const div = document.createElement('div');
    div.className = 'post-card';

    const dt = p.datetimeLocal
      ? p.datetimeLocal.replace('T', ' ')
      : (p.epoch ? new Date(p.epoch).toLocaleString() : '');

    div.innerHTML = `
      <div class="flex-between">
        <div><strong>${escapeHtml(p.location)}</strong></div>
        <div class="small">Post #${p.postNumber ?? '-'}</div>
      </div>
      <div class="small muted">Visited: ${escapeHtml(String(dt))}</div>
      <div style="margin-top:6px"><strong>${escapeHtml(p.whatFacing)}</strong></div>
      <div class="muted" style="margin-top:6px">Symptoms: ${escapeHtml(p.symptoms || 'â€”')}</div>
      <div style="margin-top:8px">
        <button class="btn secondary btn-edit" data-post-id="${p.id}">Edit</button>
        <button class="btn secondary btn-delete" style="background:#FF4B33" data-post-id="${p.id}">Delete</button>
      </div>
    `;

    myPostsEl.appendChild(div);

    // DELETE POST
    div.querySelector('.btn-delete').addEventListener('click', async (e) => {
      const postId = e.target.dataset.postId;
      if (!confirm('Are you sure you want to delete this post?')) return;
      try {
        await deleteDoc(doc(db, 'posts', postId));
        alert('Post deleted successfully.');
      } catch (err) {
        alert('Error deleting post: ' + (err.message || String(err)));
      }
    });

    // EDIT POST
    div.querySelector('.btn-edit').addEventListener('click', async (e) => {
      const postId = e.target.dataset.postId;
      const postDoc = allPosts.find(p => p.id === postId);
      if (!postDoc) return;

      const newLocation = prompt('Edit location', postDoc.location);
      if (newLocation === null) return;

      const newDate = prompt('Edit date (YYYY-MM-DD)', postDoc.datetimeLocal?.split('T')[0] || '');
      if (newDate === null) return;

      const newTime = prompt('Edit time (HH:MM, 24hr)', postDoc.datetimeLocal?.split('T')[1] || '');
      if (newTime === null) return;

      const newWhatFacing = prompt('Edit What am I facing', postDoc.whatFacing || '');
      if (newWhatFacing === null) return;

      const newSymptoms = prompt('Edit Symptoms', postDoc.symptoms || '');
      if (newSymptoms === null) return;

      const newDatetimeStr = `${newDate}T${newTime}:00`;
      const newEpoch = new Date(newDatetimeStr).getTime();
      if (isNaN(newEpoch)) {
        alert('Invalid date or time');
        return;
      }

      try {
        await updateDoc(doc(db, 'posts', postId), {
          location: newLocation,
          datetimeLocal: newDatetimeStr,
          epoch: newEpoch,
          whatFacing: newWhatFacing,
          symptoms: newSymptoms
        });
        alert('Post updated successfully.');
      } catch (err) {
        alert('Error updating post: ' + (err.message || String(err)));
      }
    });
  });
}

    async function computeAndRenderAlerts(allPosts) {
  console.log("âš¡ computeAndRenderAlerts running. Total posts:", allPosts.length);

  const myPosts = allPosts.filter(p => p.uid === currentUser.uid);
  const otherPosts = allPosts.filter(p => p.uid !== currentUser.uid);

  const alertsMap = new Map();

  const normalizeLocation = loc =>
    loc.trim()
       .toLowerCase()
       .replace(/[.,\/#!$%\^&\*;:{}=\-_`~()]/g, '')
       .replace(/\s+/g, ' ');

  const getDateStr = epoch => new Date(epoch).toISOString().split('T')[0]; // YYYY-MM-DD

  const alertsSentColRef = collection(db, 'users', currentUser.uid, 'alertsSent');

  for (const myp of myPosts) {
    if (!myp.location || !myp.epoch) continue;

    for (const op of otherPosts) {
      if (!op.location || !op.epoch) continue;

      if (
        normalizeLocation(op.location) === normalizeLocation(myp.location) &&
        getDateStr(op.epoch) === getDateStr(myp.epoch) &&
        op.epoch < myp.epoch
      ) {
        // check Firestore if alert already sent
        const alertDocRef = doc(alertsSentColRef, op.id);
        const alertDocSnap = await getDoc(alertDocRef);

        if (!alertDocSnap.exists()) {
          // Email not sent yet, send email
          try {
            await sendAlertEmail(currentUser.email, {
              title: `New alert for ${op.location}`,
              name: currentUserData.name || currentUser.email,
              time: op.datetimeLocal || (op.epoch ? new Date(op.epoch).toLocaleString() : ''),
              message: `${op.name || op.email} has visited ${op.location} at ${op.datetimeLocal || new Date(op.epoch).toLocaleString()} and reported: ${op.whatFacing}`
            });

            // store in Firestore
            await setDoc(alertDocRef, {
              postId: op.id,
              locationNormalized: normalizeLocation(op.location),
              datetimeEpoch: op.epoch,
              sentAt: serverTimestamp()
            });

            console.log("ðŸ“§ Alert email sent & recorded for post:", op.id);
          } catch (err) {
            console.error("âŒ Email sending failed for post:", op.id, err);
          }
        } else {
          console.log(`â„¹ï¸ Email NOT sent for post ${op.id} â€” alert already recorded.`);
        }


        // Add to alertsMap for display (only latest per location+date)
        const key = `${normalizeLocation(op.location)}_${getDateStr(op.epoch)}`;
        if (!alertsMap.has(key) || op.epoch > (alertsMap.get(key).epoch || 0)) {
          alertsMap.set(key, op);
        }
      }
    }
  }

  renderAlerts(Array.from(alertsMap.values()));
}


function renderAlerts(alertList) {
  myAlertsEl.innerHTML = '';
  if (alertList.length === 0) {
    myAlertsEl.innerHTML = '<div class="muted">No alerts.</div>';
    return;
  }

  alertList.sort((a, b) => (b.epoch || 0) - (a.epoch || 0));

  alertList.forEach(a => {
    const div = document.createElement('div');
    div.className = 'post-card alert-card';
    const dt = a.datetimeLocal
           ? a.datetimeLocal.replace('T', ' ')
           : (a.epoch ? new Date(a.epoch).toLocaleString() : '');

    div.innerHTML = `
      <div class="flex-between">
        <div><strong>${escapeHtml(a.name || a.email || 'Someone')}</strong></div>
        <div class="small">Post #${a.postNumber ?? '-'}</div>
      </div>
      <div class="small muted">Visited: ${escapeHtml(String(dt))}</div>
      <div style="margin-top:6px"><strong>${escapeHtml(a.whatFacing)}</strong></div>
      <div class="muted" style="margin-top:6px">Symptoms: ${escapeHtml(a.symptoms || 'â€”')}</div>
    `;
    myAlertsEl.appendChild(div);
  });
}




function escapeHtml(str) {
  if (!str) return '';
  return String(str).replace(/[&<>"'`=\/]/g, function (s) {
    return {
      '&': '&amp;',
      '<': '&lt;',
      '>': '&gt;',
      '"': '&quot;',
      "'": '&#39;',
      '/': '&#x2F;',
      '`': '&#x60;',
      '=': '&#x3D;'
    }[s];
  });
}

  </script>
</body>
</html>
